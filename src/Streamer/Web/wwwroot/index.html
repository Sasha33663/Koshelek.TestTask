<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="StyleSheet.css">

</head>
<body>
    <form id="inputForm" action="https://localhost:7091/api/receiver/create_message" method="post" target="hiddenFrame">
        <input type="text" name="Text" />
        <input type="number" name="Number" placeholder="*должен быть уникальным" />
        <input type="submit" id="sendBtn" value="Отправить" />

    </form>

    <iframe name="hiddenFrame" style="display:none;"></iframe>

    <div id="chatroom">

    </div>
    <div id="chatroomHistory">

    </div>
    <div></div>
    <button id="historyBtn">История</button>
    <div id="dataContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chat")
            .build();

        hubConnection.invoke("ViewMessage")
        hubConnection.start()
            .catch(function (err) {
                return console.error(err.toString());
            });


        hubConnection.on("Receive", function (text, number, date) {
            let messageElement = document.createElement("div");
            messageElement.classList.add("message", "received");

            messageElement.innerHTML = `
                        <span><strong></strong> ${text}</span>
                        <span><strong>№</strong> ${number}</span>
                        <span class="timestamp">${date}</span>`;

            document.getElementById("chatroom").appendChild(messageElement);
        });
        document.getElementById("historyBtn").addEventListener("click", function () {
            fetch('https://localhost:7094/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: `
                    query {
                        history {
                            date
                            number
                            text
                        }
                    }
                    `
                })
            })
                .then(response => response.json())  
                .then(data => {
                    displayData(data);
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        });

        function displayData(data) {
            const history = data.data.history;
            const container = document.getElementById('chatroomHistory'); 

            container.innerHTML = '';

            history.forEach(item => {
                const date = item.date
                const number = item.number;
                const text = item.text;

                const entry = document.createElement('div');
                entry.className = 'history-entry';
                entry.innerHTML = `<strong></strong> ${text}<br>
                                   <strong>№</strong> ${number}<br>
                                   <strong></strong> ${date}<br><br>`;

                container.appendChild(entry);
            });
        }
    </script>
</body>
</html>